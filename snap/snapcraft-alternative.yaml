name: kesty-whatsapp
title: Kesty WhatsApp
version: '1.2.8'
summary: Unofficial WhatsApp client for Linux
description: |
  An unofficial WhatsApp client for Linux distributions made with love.
  It is concise, simple, easy and flexible to use. Built with Electron
  to provide a native desktop experience for WhatsApp Web.
grade: stable
confinement: strict
base: core22
architectures:
  - build-on: amd64
  - build-on: arm64
  - build-on: armhf
  - build-on: ppc64el
  - build-on: s390x

parts:
  electron:
    plugin: nil
    build-packages:
      - wget
      - unzip
    override-build: |
      # Download pre-built Electron for the target architecture
      case "$CRAFT_ARCH_BUILD_FOR" in
        amd64) ELECTRON_ARCH=x64 ;;
        arm64) ELECTRON_ARCH=arm64 ;;
        armhf) ELECTRON_ARCH=armv7l ;;
        ppc64el) ELECTRON_ARCH=ppc64 ;;
        s390x) ELECTRON_ARCH=s390x ;;
        *) ELECTRON_ARCH=x64 ;;
      esac
      
      ELECTRON_VERSION="27.0.0"
      ELECTRON_URL="https://github.com/electron/electron/releases/download/v${ELECTRON_VERSION}/electron-v${ELECTRON_VERSION}-linux-${ELECTRON_ARCH}.zip"
      
      mkdir -p $CRAFT_PART_INSTALL/bin
      cd $CRAFT_PART_INSTALL/bin
      
      wget "$ELECTRON_URL" -O electron.zip
      unzip electron.zip
      rm electron.zip
      chmod +x electron
    prime:
      - bin/

  kesty-whatsapp:
    plugin: dump
    source: .
    build-packages:
      - nodejs
      - npm
    override-build: |
      # Install Node.js dependencies without Electron
      export ELECTRON_SKIP_BINARY_DOWNLOAD=1
      npm ci --production --ignore-scripts
      
      # Copy application files
      cp -r . $CRAFT_PART_INSTALL/
      
      # Remove unnecessary files
      rm -rf $CRAFT_PART_INSTALL/node_modules/electron/dist
      rm -rf $CRAFT_PART_INSTALL/.git
      rm -rf $CRAFT_PART_INSTALL/snap
      rm -rf $CRAFT_PART_INSTALL/scripts
    stage-packages:
      - libnss3
      - libxss1
      - libgconf-2-4
      - libxrandr2
      - libasound2
      - libpangocairo-1.0-0
      - libatk1.0-0
      - libcairo-gobject2
      - libgtk-3-0
      - libgdk-pixbuf2.0-0
      - libxcomposite1
      - libxcursor1
      - libxdamage1
      - libxi6
      - libxtst6
      - libappindicator1
    after: [electron]
    prime:
      - -snap/
      - -scripts/
      - -node_modules/electron/

apps:
  kesty-whatsapp:
    command: bin/electron $SNAP/main.js
    desktop: snap/gui/kesty-whatsapp.desktop
    environment:
      DISABLE_WAYLAND: 1
    plugs:
      - desktop
      - desktop-legacy
      - home
      - x11
      - unity7
      - browser-support
      - network
      - gsettings
      - audio-playback
      - audio-record
      - camera
      - removable-media
      - screen-inhibit-control
      - wayland
